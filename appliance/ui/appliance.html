<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="../../static/css/vis.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="../../static/css/bootstrap.min.css"/>
    <script src="../../static/js/jquery-3.3.1.min.js"></script>
    <script src="../../static/js/bootstrap.min.js"></script>
    <script src="../../static/js/vis.min.js"></script>
    <style type="text/css">
    #main {
      width: 1080px;
      margin-left: auto;
      margin-right: auto;
    }
    
    #col1 {
      float: left;
    }
    
    #canvas {
        width: 600px;
        height: 400px;
        border: 1px solid #444444;
        background-color: #dddddd;
    }
    #del-btn {
        width: 600px;
        margin-top: 5px;
    }
    #info {
      width: 600px;
      max-height: 400px;
      border: 1px solid #444444;
      margin-top: 5px;
    }
    #code {
      outline: 1px solid #ccc; 
      padding: 5px; 
      margin: 5px; 
      width: 460px;
      height: 800px;
      font-size: 12px;
      float: left;
    }
    .string { color: green; }
    .number { color: darkorange; }
    .boolean { color: blue; }
    .null { color: magenta; }
    .key { color: red; }
    </style>
    <title>Appliance Status: {{appliance}}</title>
</head>
<body>
  <div id="main">
    <div id="col1">
      <div id="canvas"></div>
      <button id="del-btn" type="button" class="btn btn-danger" data-toggle="modal" data-target="#del-app-confirm">
        Delete Appliance
      </button>
      <div class="modal fade" id="del-app-confirm" tabindex="-1" role="dialog" aria-labelledby="del-app-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="del-app-label">Delete Appliance</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
                <p>Do you want to delete appliance <b>{{ appliance }}</b> </p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button id="del-app-btn" type="button" class="btn btn-danger">Delete Appliance</button>
            </div>
          </div>
        </div>
      </div>
      <table id="info" class="table table-striped">
        <thead>
          <tr>
            <td>ID</td>
            <td>Type</td>
            <td>State</td>
            <td>Cloud</td>
            <td>Endpoints</td>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <pre id="code"></pre>
  </div>
  
  <script>

      function setNodeShape(node) {
        if (node.type == 'service'){
          node.shape = 'box';
        } else {
          node.shape = 'circle';
        }          
      }
      
      function getStateColor(state) {
        color = 'white';
        if (state == 'running') {
          color = '#0cce4d';
        } else if (state == 'submitted') {
          color = '#bbbbbb';
        } else if (state == 'pending') {
          color = '#f49242'
        } else if (state == 'staging') {
          color = '#f4ce42'
        } else if (state == 'failed') {
          color = '#fc0202'
        } else if (state == 'success') {
          color = '#0dd8d5'
        }
        return color;
      }
      
      function setNodeColor(node) {
        color = {border: 'black', background: getStateColor(node.state)};
        node.color = color;
        node.color.highlight = color;
      }
      
      function fillTable(app) {
        $('#info tbody').empty();
        for (i in app.containers) {
          var container = app.containers[i];
          var row = $('#info tbody').append($('<tr>'));
          row.append($('<td>', {text: container.id}));
          row.append($('<td>', {text: container.type}));
          row.append($('<td>', {text: container.state, 
                                style: 'color: ' + getStateColor(container.state) + ';'}));
          row.append($('<td>',
              {text: container.deployment == null ? '' : container.deployment.placement.cloud}));
          var endpoints = [];
          for (j in container.endpoints) {
            var endpoint = container.endpoints[j];
            var name = endpoint.name == null ?
                endpoint.host + ':' + endpoint.host_port: endpoint.name;
            endpoints.push($('<a>', {
                href: 'http://' + endpoint.host + ':' + endpoint.host_port,
                text: name,
                target: '_blank'
            }));
            endpoints.push($('<br>'));
          }
          row.append($('<td>').append(endpoints));
        }
      }
      
      function createGraphData(app) {
        var containers = [],
            dependencies = [];
        for (i in app.containers) {
          var c = app.containers[i];
          c.label = c.id;
          setNodeShape(c);
          setNodeColor(c);
          containers.push(c);
          for (j in c.dependencies) { 
            dependencies.push({
              from: c.dependencies[j], 
              to: c.id, 
              arrows: {
                to: {enabled: true, scaleFactor: 0.5}
              }
            });
          }
        }
        return {nodes: containers, edges: dependencies};
      }
    
      
      function createGraph(data) {
        var canvas = document.getElementById('canvas');
        var options = {
          nodes: {
            borderWidth: 2,
            shadow: true
          },
          edges: {
            shadow: true
          }
        };
        return new vis.Network(canvas, data, options);
      }
      
      function syntaxHighlight(json) {
          if (typeof json != 'string') {
               json = JSON.stringify(json, undefined, 2);
          }
          json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
              var cls = 'number';
              if (/^"/.test(match)) {
                  if (/:$/.test(match)) {
                      cls = 'key';
                  } else {
                      cls = 'string';
                  }
              } else if (/true|false/.test(match)) {
                  cls = 'boolean';
              } else if (/null/.test(match)) {
                  cls = 'null';
              }
              return '<span class="' + cls + '">' + match + '</span>';
          });
      }

      function deleteAppliance() {
        $.ajax({
            url: "../../appliance/{{appliance}}",
            type: "DELETE",
            success: function() {
              location.reload();
            }
          });
      }

      function getApplianceUpdates(){
          $.ajax({
            url: "../../appliance/{{appliance}}",
            success: function(result, status, xhr) {
              if (status == 404) {
                console.log('Cannot find appliance {{appliance}}');
              }
              var app = JSON.parse(result);
              fillTable(app);
              var data = createGraphData(app);
              var graph = createGraph(data);
              var nodesById = {}
              for (i in data.nodes) {
                nodesById[data.nodes[i].id] = data.nodes[i];
              }
              graph.on('click', function(params){
                var node = $.extend({}, nodesById[params.nodes[0]]);
                delete node.color;
                delete node.label;
                delete node.shape;
                $('#main #code').html(syntaxHighlight(JSON.stringify(node, null, 2)));
              });
            }

          });
      }

      getApplianceUpdates()
      setInterval(getApplianceUpdates, 5000)

      $('#del-app-btn').on('click', function() {
        deleteAppliance();
      });

  </script>
</body>
</html>
